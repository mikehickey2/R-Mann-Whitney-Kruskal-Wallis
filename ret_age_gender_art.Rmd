---
title: "age_gender_article_analysis"
author: "Michael Hickey"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    toc_depth: 3
params:
  data_file: "data/retention.csv"
---

## SETUP

```{r setup, include=FALSE}

## Packages
library(tidyverse)
library(usethis)
library(gmodels)
library(FSA)
library(PMCMRplus)
library(DescTools)
library(ggplot2)
library(dplyr)
library(readr)
library(janitor)
library(here)
library(rstatix)
library(knitr)
library(stringr)

knitr::opts_chunk$set(echo = TRUE)

```

## Data work

```{r load-data}
raw <- read_csv(
  here(params$data_file),            # data/retention.csv
  show_col_types = FALSE
)

# Row 1 = headers; rows 2‑3 are survey text & metadata → drop them
retention_data <- raw %>%
  slice(-(1:2)) %>%                 # remove rows 2 & 3
  clean_names()                     # snake_case headers

# Remove unwanted metadata columns
ignore_cols <- c(
  "start_date", "end_date", "status", "progress", "duration_in_seconds",
  "recorded_date", "response_id", "distribution_channel",
  "user_language", "q_recaptcha_score"
)
retention_data <- retention_data %>% select(-all_of(ignore_cols))

```

```{r filter-and-count}
total_records <- nrow(retention_data)

cleaned <- retention_data %>%
  mutate(
    finished         = toupper(as.character(finished)),
    informed_consent = toupper(as.character(informed_consent)),
    screener         = toupper(as.character(screener))
  ) %>%
  mutate(
    exclusion_reason = case_when(
      informed_consent != "YES" ~ "did_not_consent",
      finished         != "TRUE" ~ "did_not_finish",
      screener         != "YES" ~ "not_air_carrier",
      TRUE                     ~ "included"
    )
  )

exclusion_table <- cleaned %>%
  count(exclusion_reason, name = "n")

knitr::kable(exclusion_table, caption = "Why Records Were Excluded")

included_data <- cleaned %>%
  filter(exclusion_reason == "included") %>%
  select(-exclusion_reason)         # drop helper column

cat("**Total records in file:**", total_records,
    "\\n\\n**Records kept for analysis:**", nrow(included_data),
    "\\n\\n**Records excluded:**", total_records - nrow(included_data))
```

## Descriptives

```{r age-descriptives}
library(DescTools)   # for Skew() and Kurt()

# ---- 1. make sure age is numeric ---------------------------------------
included_data <- included_data %>%
  mutate(age = as.numeric(age))

# ---- 2. summary table ---------------------------------------------------
age_summary <- included_data %>%
  summarise(
    n           = sum(!is.na(age)),
    min_age     = min(age, na.rm = TRUE),
    q1_age      = quantile(age, 0.25, na.rm = TRUE),
    median_age  = median(age, na.rm = TRUE),
    mean_age    = mean(age, na.rm = TRUE),
    q3_age      = quantile(age, 0.75, na.rm = TRUE),
    max_age     = max(age, na.rm = TRUE),
    sd_age      = sd(age, na.rm = TRUE),
    iqr_age     = IQR(age, na.rm = TRUE),
    skew_age    = Skew(age, na.rm = TRUE),
    kurt_age    = Kurt(age, na.rm = TRUE)
  )

knitr::kable(age_summary, digits = 2,
             caption = "Descriptive Statistics for Age")

# ---- 3. normality test --------------------------------------------------
if (age_summary$n <= 5000) {
  shapiro_p <- shapiro.test(included_data$age)$p.value
  cat("\nShapiro–Wilk normality test p‑value:", round(shapiro_p, 4), "\n")
}

# ---- 4. histogram + density --------------------------------------------
ggplot(included_data, aes(x = age)) +
  geom_histogram(aes(y = ..density..), bins = 15,
                 fill = "steelblue", alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Age Distribution",
       x = "Age (years)", y = "Density") +
  theme_minimal()

# ---- 5. box‑plot for outliers ------------------------------------------
ggplot(included_data, aes(y = age)) +
  geom_boxplot(fill = "orange", width = 0.25) +
  labs(title = "Age Box‑Plot", y = "Age (years)") +
  theme_minimal()
```

```{r gender-descriptives}
library(janitor)   # tabyl + adorn

# 1 Frequency table with counts & percentages -----------------------------
gender_table <- included_data %>%
  tabyl(gender) %>%              # counts
  adorn_totals("row") %>%        # add Total row
  adorn_pct_formatting(digits = 1)  # add percent column

knitr::kable(gender_table, caption = "Gender Distribution")

# 2 Count of missing responses -------------------------------------------
missing_gender <- sum(is.na(included_data$gender) | included_data$gender == "")
cat("\nMissing / blank gender responses:", missing_gender, "\n")

# 3 Bar chart -------------------------------------------------------------
ggplot(included_data, aes(x = gender)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Gender Distribution", x = "Gender", y = "Count") +
  theme_minimal()
```

## General Rank Analysis

```{r RQ1-general-rank-analysis}

# map data columns to factor names
included_data <- included_data %>%
  rename(
    financial_rank    = general_1,
    lifestyle_rank    = general_2,
    professional_rank = general_3,
    recognition_rank  = general_4,
    schedule_rank     = general_5,
    operational_rank  = general_6
  )

rank_cols <- included_data %>%
  select(ends_with("_rank")) %>%
  names()

# ---- 1. build participant ID + tidy long --------------------------------
general_long <- included_data %>%
  mutate(pid = row_number()) %>%            # unique ID per pilot
  select(pid, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to  = "factor",
               values_to = "rank") %>%
  mutate(factor = str_remove(factor, "_rank$"))

# ---- 2. Table 1: median & IQR ------------------------------------------
rank_summary <- general_long %>%
  group_by(factor) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    iqr    = IQR(rank, na.rm = TRUE)
  ) %>%
  arrange(median)

knitr::kable(rank_summary,
             caption = "Table 1\nRank Summary for General Retention Factors",
             digits = 1)

# ---- 3. Table 2: count of rank = 1 -------------------------------------
top_factor_tbl <- general_long %>%
  filter(rank == 1) %>%
  count(factor, name = "n") %>%
  mutate(percent = n / sum(n) * 100) %>%
  arrange(desc(n))

knitr::kable(top_factor_tbl,
             digits = 1,
             caption = "Table 2\nNumber (and %) of Pilots Ranking Each Factor #1")

# ---- 4. Bar chart -------------------------------------------------------
ggplot(top_factor_tbl, aes(x = reorder(factor, -n), y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Figure 1\nMost Important Retention Factor",
       x = "Factor Ranked #1", y = "Number of Pilots") +
  theme_minimal()

# ---- 5. Friedman test ---------------------------------------------------
library(rstatix)
friedman_res <- general_long %>%
  friedman_test(rank ~ factor | pid)

print(friedman_res)
```

```{r RQ1-posthoc-pairwise}

pairwise_tbl <- general_long %>%
  mutate(rank = as.numeric(rank)) %>%          # <‑‑ convert here
  pairwise_wilcox_test(
    rank ~ factor,
    paired = TRUE,
    p.adjust.method = "bonferroni"
  ) %>%
  mutate(
    comparison = str_c(group1, " vs ", group2),
    p.adj      = round(p.adj, 3),
    p.sig      = if_else(p.adj < .001, "< .001", as.character(p.adj))
    # effect size optional; removed for simplicity
  ) %>%
  select(comparison, p.sig)

knitr::kable(pairwise_tbl,
             caption = "Table 3\nPairwise Wilcoxon Tests Between General Factors\n(Bonferroni‑adjusted p‑values)")
```

## Age Analysis

```{r RQ2a-age-groups}

# 1 ── create age‑group (<=35 vs >35) ------------------------------------
included_data <- included_data %>%
  mutate(age_group = if_else(age <= 35, "≤ 35", "> 35"))

# 2 ── gather ranks to long format (reuse earlier rank_cols) -------------
general_age_long <- included_data %>%
  select(age_group, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to = "factor",
               values_to = "rank") %>%
  mutate(
    factor = str_remove(factor, "_rank$"),
    rank   = as.numeric(rank)        # ensure numeric
  )

# 3 ── summary table: medians by group -----------------------------------
age_medians <- general_age_long %>%
  group_by(factor, age_group) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = age_group,
    values_from = c(n, median),
    names_glue  = "{age_group}_{.value}"
  ) %>%
  # reorder columns so ≤ 35 comes first
  select(factor,
         `≤ 35_n`, `≤ 35_median`,
         `> 35_n`, `> 35_median`)

# 4 ── Mann‑Whitney tests per factor -------------------------------------
mw_tbl <- general_age_long %>%
  group_by(factor) %>%
  wilcox_test(rank ~ age_group, exact = FALSE) %>%  # asymptotic; >30 per group
  mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
  select(factor, p_adj)

# 5 ── merge medians + p-values ------------------------------------------
results_tbl <- age_medians %>%
  left_join(mw_tbl, by = "factor") %>%
  arrange(p_adj)

knitr::kable(results_tbl,
             digits = 2,
             col.names = c("Factor",
                           "n ≤35", "Median ≤35",
                           "n >35", "Median >35",
                           "p (Bonferroni)"),
             caption = "Table 4\nMann‑Whitney U Tests: Age Groups (≤ 35 vs > 35) on General‑Factor Ranks")
```

## Gender Analysis

```{r RQ2c-gender-clean}
library(dplyr); library(tidyr); library(rstatix); library(stringr); library(knitr)

# ── 1. robust gender cleaning ────────────────────────────────────────────
included_data <- included_data %>%
  mutate(
    gender_raw = trimws(gender),            # keep original if you like
    gender = case_when(
      str_starts(tolower(gender_raw), "m")                ~ "Male",
      str_starts(tolower(gender_raw), "f")                ~ "Female",
      str_detect(tolower(gender_raw), "non|other")        ~ "Other",
      TRUE                                                ~ NA_character_
    )
  )

# counts for transparency
cat("Gender counts:\n")
print(table(included_data$gender, useNA = "ifany"))  # should be 67/8/1

# ── 2. prepare long rank data ────────────────────────────────────────────
general_gender_long <- included_data %>%
  select(gender, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to = "factor",
               values_to = "rank") %>%
  mutate(
    factor = str_remove(factor, "_rank$"),
    rank   = as.numeric(rank)
  ) %>%
  filter(gender %in% c("Male", "Female"))   # exclude "Other" if n < 5

# ── 3. Table 7: medians by gender ────────────────────────────────────────
gender_medians <- general_gender_long %>%
  group_by(factor, gender) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = gender,
    values_from = c(n, median),
    names_glue  = "{gender}_{.value}"
  )

knitr::kable(gender_medians,
             digits = 1,
             caption = "Table 7\nMedian Rank of General Factors by Gender")

# ── 4. Mann‑Whitney U tests (Male vs Female) ─────────────────────────────
gender_counts <- table(included_data$gender)
if(all(c("Male", "Female") %in% names(gender_counts)) &&
   all(gender_counts[c("Male", "Female")] >= 5)) {

  mw_gender <- general_gender_long %>%
    group_by(factor) %>%
    wilcox_test(rank ~ gender, exact = FALSE) %>%
    mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
    select(factor, p_adj)

  knitr::kable(mw_gender,
               digits = 3,
               caption = "Table 8\nMann‑Whitney U Tests: Male vs Female (Bonferroni‑adjusted p)")
} else {
  cat("\nMann‑Whitney tests skipped: fewer than 5 cases in one gender group.\n")
}
```












