---
title: "Airline Pilot Retention Analysis"
author: "Mike Hickey"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    toc_depth: 3
params:
  data_file: "data/retention.csv"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

## Packages
library(tidyverse)
library(usethis)
library(gmodels)
library(FSA)
library(PMCMRplus)
library(DescTools)
library(ggplot2)
library(dplyr)
library(readr)
library(janitor)
library(here)
library(rstatix)
library(knitr)
library(stringr)
```

```{r load-data}
raw <- read_csv(
  here(params$data_file),            # data/retention.csv
  show_col_types = FALSE
)

# Row 1 = headers; rows 2‑3 are survey text & metadata → drop them
retention_data <- raw %>%
  slice(-(1:2)) %>%                 # remove rows 2 & 3
  clean_names()                     # snake_case headers

# Remove unwanted metadata columns
ignore_cols <- c(
  "start_date", "end_date", "status", "progress", "duration_in_seconds",
  "recorded_date", "response_id", "distribution_channel",
  "user_language", "q_recaptcha_score"
)
retention_data <- retention_data %>% select(-all_of(ignore_cols))

```

```{r filter-and-count}
total_records <- nrow(retention_data)

cleaned <- retention_data %>%
  mutate(
    finished         = toupper(as.character(finished)),
    informed_consent = toupper(as.character(informed_consent)),
    screener         = toupper(as.character(screener))
  ) %>%
  mutate(
    exclusion_reason = case_when(
      informed_consent != "YES" ~ "did_not_consent",
      finished         != "TRUE" ~ "did_not_finish",
      screener         != "YES" ~ "not_air_carrier",
      TRUE                     ~ "included"
    )
  )

exclusion_table <- cleaned %>%
  count(exclusion_reason, name = "n")

knitr::kable(exclusion_table, caption = "Why Records Were Excluded")

included_data <- cleaned %>%
  filter(exclusion_reason == "included") %>%
  select(-exclusion_reason)         # drop helper column

cat("**Total records in file:**", total_records,
    "\\n\\n**Records kept for analysis:**", nrow(included_data),
    "\\n\\n**Records excluded:**", total_records - nrow(included_data))
```

```{r write-clean, echo = TRUE}
write_csv(included_data, here("data/retention_cleaned.csv"))
```

\#`{r preview-clean, echo = FALSE} #knitr::kable(head(included_data), caption = "Preview of Cleaned Data") #`

```{r age-descriptives}
library(DescTools)   # for Skew() and Kurt()

# ---- 1. make sure age is numeric ---------------------------------------
included_data <- included_data %>%
  mutate(age = as.numeric(age))

# ---- 2. summary table ---------------------------------------------------
age_summary <- included_data %>%
  summarise(
    n           = sum(!is.na(age)),
    min_age     = min(age, na.rm = TRUE),
    q1_age      = quantile(age, 0.25, na.rm = TRUE),
    median_age  = median(age, na.rm = TRUE),
    mean_age    = mean(age, na.rm = TRUE),
    q3_age      = quantile(age, 0.75, na.rm = TRUE),
    max_age     = max(age, na.rm = TRUE),
    sd_age      = sd(age, na.rm = TRUE),
    iqr_age     = IQR(age, na.rm = TRUE),
    skew_age    = Skew(age, na.rm = TRUE),
    kurt_age    = Kurt(age, na.rm = TRUE)
  )

knitr::kable(age_summary, digits = 2,
             caption = "Descriptive Statistics for Age")

# ---- 3. normality test --------------------------------------------------
if (age_summary$n <= 5000) {
  shapiro_p <- shapiro.test(included_data$age)$p.value
  cat("\nShapiro–Wilk normality test p‑value:", round(shapiro_p, 4), "\n")
}

# ---- 4. histogram + density --------------------------------------------
ggplot(included_data, aes(x = age)) +
  geom_histogram(aes(y = ..density..), bins = 15,
                 fill = "steelblue", alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Age Distribution",
       x = "Age (years)", y = "Density") +
  theme_minimal()

# ---- 5. box‑plot for outliers ------------------------------------------
ggplot(included_data, aes(y = age)) +
  geom_boxplot(fill = "orange", width = 0.25) +
  labs(title = "Age Box‑Plot", y = "Age (years)") +
  theme_minimal()
```

```{r age-cutoff-35}
library(dplyr); library(knitr)

age_35_tbl <- included_data %>%
  mutate(age_group = if_else(age <= 35, "≤ 35", "> 35")) %>%
  count(age_group, name = "n") %>%
  mutate(percent = n / sum(n) * 100) %>%
  arrange(desc(age_group))  # optional: puts "> 35" second

knitr::kable(age_35_tbl,
             digits = 1,
             col.names = c("Age Group", "n", "%"),
             caption = "Age Distribution: ≤ 35 vs > 35")
```

```{r experience-descriptives}
library(DescTools)   # for Skew() and Kurt()

# 1 Ensure the variable is numeric
included_data <- included_data %>%
  mutate(experience = as.numeric(experience))

# 2 Summary table
experience_summary <- included_data %>%
  summarise(
    n                = sum(!is.na(experience)),
    min_exp          = min(experience, na.rm = TRUE),
    q1_exp           = quantile(experience, 0.25, na.rm = TRUE),
    median_exp       = median(experience, na.rm = TRUE),
    mean_exp         = mean(experience, na.rm = TRUE),
    q3_exp           = quantile(experience, 0.75, na.rm = TRUE),
    max_exp          = max(experience, na.rm = TRUE),
    sd_exp           = sd(experience, na.rm = TRUE),
    iqr_exp          = IQR(experience, na.rm = TRUE),
    skew_exp         = Skew(experience, na.rm = TRUE),
    kurt_exp         = Kurt(experience, na.rm = TRUE)
  )

knitr::kable(experience_summary, digits = 2,
             caption = "Descriptive Statistics for Years of Experience")

# 3 Normality test (Shapiro–Wilk)
if (experience_summary$n <= 5000) {
  shapiro_p <- shapiro.test(included_data$experience)$p.value
  cat("\nShapiro–Wilk normality test p‑value:",
      format(shapiro_p, digits = 4), "\n")
}

# 4 Histogram + density curve
ggplot(included_data, aes(x = experience)) +
  geom_histogram(aes(y = ..density..), bins = 15,
                 fill = "steelblue", alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Years of Experience Distribution",
       x = "Years of Experience", y = "Density") +
  theme_minimal()

# 5 Box‑plot
ggplot(included_data, aes(y = experience)) +
  geom_boxplot(fill = "orange", width = 0.25) +
  labs(title = "Years of Experience Box‑Plot",
       y = "Years of Experience") +
  theme_minimal()
```

```{r total-flying-hours-descriptives}
library(DescTools)   # Skew() and Kurt()

# 1 Ensure the variable is numeric ---------------------------------------
included_data <- included_data %>%
  mutate(total_flying_hours = as.numeric(total_flying_hours))

# 2 Summary statistics ----------------------------------------------------
hours_summary <- included_data %>%
  summarise(
    n               = sum(!is.na(total_flying_hours)),
    min_hours       = min(total_flying_hours, na.rm = TRUE),
    q1_hours        = quantile(total_flying_hours, 0.25, na.rm = TRUE),
    median_hours    = median(total_flying_hours, na.rm = TRUE),
    mean_hours      = mean(total_flying_hours, na.rm = TRUE),
    q3_hours        = quantile(total_flying_hours, 0.75, na.rm = TRUE),
    max_hours       = max(total_flying_hours, na.rm = TRUE),
    sd_hours        = sd(total_flying_hours, na.rm = TRUE),
    iqr_hours       = IQR(total_flying_hours, na.rm = TRUE),
    skew_hours      = Skew(total_flying_hours, na.rm = TRUE),
    kurt_hours      = Kurt(total_flying_hours, na.rm = TRUE)
  )

knitr::kable(hours_summary, digits = 2,
             caption = "Descriptive Statistics for Total Flying Hours")

# 3 Shapiro–Wilk normality test ------------------------------------------
if (hours_summary$n <= 5000) {
  shapiro_p <- shapiro.test(included_data$total_flying_hours)$p.value
  cat("\nShapiro–Wilk normality test p‑value:",
      format(shapiro_p, digits = 4), "\n")
}

# 4 Histogram with density overlay ---------------------------------------
ggplot(included_data, aes(x = total_flying_hours)) +
  geom_histogram(aes(y = ..density..), bins = 15,
                 fill = "steelblue", alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Total Flying Hours Distribution",
       x = "Total Flying Hours", y = "Density") +
  theme_minimal()

# 5 Box‑plot for outlier check -------------------------------------------
ggplot(included_data, aes(y = total_flying_hours)) +
  geom_boxplot(fill = "orange", width = 0.25) +
  labs(title = "Total Flying Hours Box‑Plot",
       y = "Total Flying Hours") +
  theme_minimal()
```

```{r gender-descriptives}
library(janitor)   # tabyl + adorn

# 1 Frequency table with counts & percentages -----------------------------
gender_table <- included_data %>%
  tabyl(gender) %>%              # counts
  adorn_totals("row") %>%        # add Total row
  adorn_pct_formatting(digits = 1)  # add percent column

knitr::kable(gender_table, caption = "Gender Distribution")

# 2 Count of missing responses -------------------------------------------
missing_gender <- sum(is.na(included_data$gender) | included_data$gender == "")
cat("\nMissing / blank gender responses:", missing_gender, "\n")

# 3 Bar chart -------------------------------------------------------------
ggplot(included_data, aes(x = gender)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Gender Distribution", x = "Gender", y = "Count") +
  theme_minimal()
```

```{r carrier-type-descriptives}
library(janitor)   # tabyl + adorn

# 1 Frequency table with counts & percentages -----------------------------
carrier_table <- included_data %>%
  tabyl(air_carrier_type) %>%            # counts
  adorn_totals("row") %>%                # add Total row
  adorn_pct_formatting(digits = 1)       # add percent column

knitr::kable(carrier_table,
             caption = "Air‑Carrier Type Distribution")

# 2 Missing responses -----------------------------------------------------
missing_carrier <- sum(is.na(included_data$air_carrier_type) |
                         included_data$air_carrier_type == "")
cat("\nMissing / blank carrier‑type responses:",
    missing_carrier, "\n")

# 3 Bar chart -------------------------------------------------------------
ggplot(included_data, aes(x = air_carrier_type)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Air‑Carrier Type Distribution",
       x = "Carrier Type", y = "Count") +
  theme_minimal()
```

```{r position-descriptives}
library(janitor)   # tabyl + adorn

# 1 Frequency table: counts + percentages ------------------------------
position_table <- included_data %>%
  tabyl(position_position) %>%          # counts
  adorn_totals("row") %>%               # add Total row
  adorn_pct_formatting(digits = 1)      # add % column

knitr::kable(position_table,
             caption = "Flight‑Deck Position Distribution")

# 2 Missing responses ---------------------------------------------------
missing_pos <- sum(is.na(included_data$position_position) |
                     included_data$position_position == "")
cat("\nMissing / blank position responses:",
    missing_pos, "\n")

# 3 Bar chart -----------------------------------------------------------
ggplot(included_data, aes(x = position_position)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Flight‑Deck Position Distribution",
       x = "Position", y = "Count") +
  theme_minimal()
```

```{r military-experience-descriptives}
library(janitor)   # tabyl + adorn

# 1 Recode (two exact strings) -------------------------------------------
included_data <- included_data %>%
  mutate(
    military_bg = case_when(
      military_experience == "Previously served in the military" ~ "Yes",
      military_experience == "Never served in the military"      ~ "No",
      TRUE                                                       ~ NA_character_   # catch unexpected
    )
  )

# 2 Frequency table -------------------------------------------------------
mil_table <- included_data %>%
  tabyl(military_bg) %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

knitr::kable(mil_table,
             caption = "Military Experience Distribution (Yes / No)")

# 3 Missing responses -----------------------------------------------------
missing_mil <- sum(is.na(included_data$military_bg))
cat("\nMissing military‑experience responses:", missing_mil, "\n")

# 4 Bar chart -------------------------------------------------------------
ggplot(included_data, aes(x = military_bg)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Military Background (Yes / No)",
       x = "Military Background", y = "Count") +
  theme_minimal()
```

```{r nationality-descriptives}
library(janitor)   # tabyl + adorn
library(stringr)   # str_detect

# ── Part A  Full country table ───────────────────────────────────────────
country_table <- included_data %>%
  tabyl(nationality) %>%           # counts
  arrange(desc(n)) %>%
  adorn_pct_formatting(digits = 1)

knitr::kable(country_table,
             caption = "Nationality – Full Country Breakdown")

# ── Part B  U.S. vs Foreign recode ───────────────────────────────────────
included_data <- included_data %>%
  mutate(
    us_vs_foreign = case_when(
      str_detect(nationality, regex("^united states", ignore_case = TRUE)) |
      str_detect(nationality, regex("^usa$", ignore_case = TRUE))          ~ "US",
      is.na(nationality) | nationality == ""                               ~ NA_character_,
      TRUE                                                                 ~ "Foreign"
    )
  )

# Counts & percentages
us_table <- included_data %>%
  tabyl(us_vs_foreign) %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

knitr::kable(us_table,
             caption = "Nationality Re‑coded to US vs Foreign")

# Bar chart
ggplot(included_data, aes(x = us_vs_foreign)) +
  geom_bar(fill = "steelblue") +
  labs(title = "US vs Foreign Pilots",
       x = "Group", y = "Count") +
  theme_minimal()
```

### --RESEARCH QUESTION ANALYSES--

```{r RQ1-general-rank-analysis}

# map data columns to factor names
included_data <- included_data %>%
  rename(
    financial_rank    = general_1,
    lifestyle_rank    = general_2,
    professional_rank = general_3,
    recognition_rank  = general_4,
    schedule_rank     = general_5,
    operational_rank  = general_6
  )

rank_cols <- included_data %>%
  select(ends_with("_rank")) %>%
  names()

# ---- 1. build participant ID + tidy long --------------------------------
general_long <- included_data %>%
  mutate(pid = row_number()) %>%            # unique ID per pilot
  select(pid, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to  = "factor",
               values_to = "rank") %>%
  mutate(factor = str_remove(factor, "_rank$"))

# ---- 2. Table 1: median & IQR ------------------------------------------
rank_summary <- general_long %>%
  group_by(factor) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    iqr    = IQR(rank, na.rm = TRUE)
  ) %>%
  arrange(median)

knitr::kable(rank_summary,
             caption = "Table 1\nRank Summary for General Retention Factors",
             digits = 1)

# ---- 3. Table 2: count of rank = 1 -------------------------------------
top_factor_tbl <- general_long %>%
  filter(rank == 1) %>%
  count(factor, name = "n") %>%
  mutate(percent = n / sum(n) * 100) %>%
  arrange(desc(n))

knitr::kable(top_factor_tbl,
             digits = 1,
             caption = "Table 2\nNumber (and %) of Pilots Ranking Each Factor #1")

# ---- 4. Bar chart -------------------------------------------------------
ggplot(top_factor_tbl, aes(x = reorder(factor, -n), y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Figure 1\nMost Important Retention Factor",
       x = "Factor Ranked #1", y = "Number of Pilots") +
  theme_minimal()

# ---- 5. Friedman test ---------------------------------------------------
library(rstatix)
friedman_res <- general_long %>%
  friedman_test(rank ~ factor | pid)

print(friedman_res)
```

```{r RQ1-posthoc-pairwise}

pairwise_tbl <- general_long %>%
  mutate(rank = as.numeric(rank)) %>%          # <‑‑ convert here
  pairwise_wilcox_test(
    rank ~ factor,
    paired = TRUE,
    p.adjust.method = "bonferroni"
  ) %>%
  mutate(
    comparison = str_c(group1, " vs ", group2),
    p.adj      = round(p.adj, 3),
    p.sig      = if_else(p.adj < .001, "< .001", as.character(p.adj))
    # effect size optional; removed for simplicity
  ) %>%
  select(comparison, p.sig)

knitr::kable(pairwise_tbl,
             caption = "Table 3\nPairwise Wilcoxon Tests Between General Factors\n(Bonferroni‑adjusted p‑values)")
```

```{r RQ2a-age-groups}

# 1 ── create age‑group (<=35 vs >35) ------------------------------------
included_data <- included_data %>%
  mutate(age_group = if_else(age <= 35, "≤ 35", "> 35"))

# 2 ── gather ranks to long format (reuse earlier rank_cols) -------------
general_age_long <- included_data %>%
  select(age_group, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to = "factor",
               values_to = "rank") %>%
  mutate(
    factor = str_remove(factor, "_rank$"),
    rank   = as.numeric(rank)        # ensure numeric
  )

# 3 ── summary table: medians by group -----------------------------------
age_medians <- general_age_long %>%
  group_by(factor, age_group) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = age_group,
    values_from = c(n, median),
    names_glue  = "{age_group}_{.value}"
  ) %>%
  # reorder columns so ≤ 35 comes first
  select(factor,
         `≤ 35_n`, `≤ 35_median`,
         `> 35_n`, `> 35_median`)

# 4 ── Mann‑Whitney tests per factor -------------------------------------
mw_tbl <- general_age_long %>%
  group_by(factor) %>%
  wilcox_test(rank ~ age_group, exact = FALSE) %>%  # asymptotic; >30 per group
  mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
  select(factor, p_adj)

# 5 ── merge medians + p-values ------------------------------------------
results_tbl <- age_medians %>%
  left_join(mw_tbl, by = "factor") %>%
  arrange(p_adj)

knitr::kable(results_tbl,
             digits = 2,
             col.names = c("Factor",
                           "n ≤35", "Median ≤35",
                           "n >35", "Median >35",
                           "p (Bonferroni)"),
             caption = "Table 4\nMann‑Whitney U Tests: Age Groups (≤ 35 vs > 35) on General‑Factor Ranks")
```

```{r RQ2b-experience-quartiles}
library(dplyr);  library(tidyr);  library(rstatix);  library(knitr)

# 1 ── create experience quartiles ---------------------------------------
included_data <- included_data %>%
  mutate(
    experience = as.numeric(experience),
    exp_q = ntile(experience, 4)           # Q1 (least) → Q4 (most)
  ) %>%
  mutate(
    exp_q = factor(exp_q,
                   levels = 1:4,
                   labels = c("Q1 (least)", "Q2", "Q3", "Q4 (most)"))
  )

# 2 ── long format for ranks ---------------------------------------------
general_exp_long <- included_data %>%
  select(exp_q, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to = "factor",
               values_to = "rank") %>%
  mutate(
    factor = str_remove(factor, "_rank$"),
    rank   = as.numeric(rank)
  )

# 3 ── Table 5: medians by experience quartile ---------------------------
exp_medians <- general_exp_long %>%
  group_by(factor, exp_q) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = exp_q,
    values_from = c(n, median),
    names_glue  = "{exp_q}_{.value}"
  )

knitr::kable(exp_medians,
             caption = "Table 5\nMedian Rank of General Factors by Experience Quartile",
             digits = 1)

# 4 ── Kruskal–Wallis per factor -----------------------------------------
kw_tbl <- general_exp_long %>%
  group_by(factor) %>%
  kruskal_test(rank ~ exp_q) %>%
  mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
  select(factor, statistic, df, p_adj)

knitr::kable(kw_tbl,
             digits = 3,
             caption = "Table 6\nKruskal–Wallis Tests for Experience Quartiles (Bonferroni‑adjusted p)")

```

```{r RQ2c-gender-clean}
library(dplyr); library(tidyr); library(rstatix); library(stringr); library(knitr)

# ── 1. robust gender cleaning ────────────────────────────────────────────
included_data <- included_data %>%
  mutate(
    gender_raw = trimws(gender),            # keep original if you like
    gender = case_when(
      str_starts(tolower(gender_raw), "m")                ~ "Male",
      str_starts(tolower(gender_raw), "f")                ~ "Female",
      str_detect(tolower(gender_raw), "non|other")        ~ "Other",
      TRUE                                                ~ NA_character_
    )
  )

# counts for transparency
cat("Gender counts:\n")
print(table(included_data$gender, useNA = "ifany"))  # should be 67/8/1

# ── 2. prepare long rank data ────────────────────────────────────────────
general_gender_long <- included_data %>%
  select(gender, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to = "factor",
               values_to = "rank") %>%
  mutate(
    factor = str_remove(factor, "_rank$"),
    rank   = as.numeric(rank)
  ) %>%
  filter(gender %in% c("Male", "Female"))   # exclude "Other" if n < 5

# ── 3. Table 7: medians by gender ────────────────────────────────────────
gender_medians <- general_gender_long %>%
  group_by(factor, gender) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = gender,
    values_from = c(n, median),
    names_glue  = "{gender}_{.value}"
  )

knitr::kable(gender_medians,
             digits = 1,
             caption = "Table 7\nMedian Rank of General Factors by Gender")

# ── 4. Mann‑Whitney U tests (Male vs Female) ─────────────────────────────
gender_counts <- table(included_data$gender)
if(all(c("Male", "Female") %in% names(gender_counts)) &&
   all(gender_counts[c("Male", "Female")] >= 5)) {

  mw_gender <- general_gender_long %>%
    group_by(factor) %>%
    wilcox_test(rank ~ gender, exact = FALSE) %>%
    mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
    select(factor, p_adj)

  knitr::kable(mw_gender,
               digits = 3,
               caption = "Table 8\nMann‑Whitney U Tests: Male vs Female (Bonferroni‑adjusted p)")
} else {
  cat("\nMann‑Whitney tests skipped: fewer than 5 cases in one gender group.\n")
}
```

```{r RQ2d-military}
library(dplyr); library(tidyr); library(rstatix); library(knitr)

# 1 ── assure military_bg is Yes/No --------------------------------------
included_data <- included_data %>%
  mutate(
    military_bg = factor(military_bg, levels = c("Yes", "No"))
  )

cat("Military background counts:\n")
print(table(included_data$military_bg, useNA = "ifany"))  # 7 Yes, 69 No

# 2 ── long rank data -----------------------------------------------------
general_mil_long <- included_data %>%
  select(military_bg, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to = "factor",
               values_to = "rank") %>%
  mutate(
    factor = str_remove(factor, "_rank$"),
    rank   = as.numeric(rank)
  ) %>%
  filter(!is.na(military_bg))

# 3 ── Table 9: medians by military BG -----------------------------------
mil_medians <- general_mil_long %>%
  group_by(factor, military_bg) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = military_bg,
    values_from = c(n, median),
    names_glue  = "{military_bg}_{.value}"
  )

knitr::kable(mil_medians,
             digits = 1,
             caption = "Table 9\nMedian Rank of General Factors by Military Background")

# 4 ── Mann‑Whitney tests -------------------------------------------------
## Only run if both Yes and No groups have >= 5 cases
mil_counts <- table(included_data$military_bg)
if(all(mil_counts >= 5)){
  mw_mil <- general_mil_long %>%
    group_by(factor) %>%
    wilcox_test(rank ~ military_bg, exact = FALSE) %>%
    mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
    select(factor, p_adj)
  
  knitr::kable(mw_mil,
               digits = 3,
               caption = "Table 10\nMann‑Whitney U Tests: Military vs Civilian (Bonferroni‑adjusted p)")
} else {
  cat("\nMann‑Whitney skipped: fewer than 5 military cases.\n")
}
```

```{r RQ2e-carrier-type}
library(dplyr); library(tidyr); library(rstatix); library(knitr); library(stringr)

# 1. recode air_carrier_type ---------------------------------------------
included_data <- included_data %>%
  mutate(
    carrier_grp = case_when(
      str_detect(air_carrier_type, "Regional")             ~ "Regional",
      str_detect(air_carrier_type, "Legacy|Mainline")      ~ "Major",
      str_detect(air_carrier_type, "Low Cost")             ~ "LCC",
      TRUE                                                 ~ "Other"
    )
  )

cat("Carrier group counts:\n")
print(table(included_data$carrier_grp))

# 2. long ranks -----------------------------------------------------------
carrier_long <- included_data %>%
  select(carrier_grp, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to = "factor",
               values_to = "rank") %>%
  mutate(
    factor = str_remove(factor, "_rank$"),
    rank   = as.numeric(rank)
  )

# 3. Table 11: medians by carrier grp ------------------------------------
carrier_medians <- carrier_long %>%
  group_by(factor, carrier_grp) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = carrier_grp,
    values_from = c(n, median),
    names_glue  = "{carrier_grp}_{.value}"
  )

knitr::kable(carrier_medians,
             digits = 1,
             caption = "Table 11\nMedian Rank of General Factors by Carrier Group")

# 4. Kruskal–Wallis per factor -------------------------------------------
kw_carrier <- carrier_long %>%
  group_by(factor) %>%
  kruskal_test(rank ~ carrier_grp) %>%
  mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
  select(factor, statistic, df, p_adj)

knitr::kable(kw_carrier,
             digits = 3,
             caption = "Table 12\nKruskal–Wallis Tests Across Carrier Groups (Bonferroni‑adjusted p)")
```

```{r final-heatmap}
library(dplyr); library(tidyr); library(ggplot2); library(stringr)

# 1. assemble median tables into a single frame --------------------------
med_age   <- age_medians   %>% pivot_longer(-factor) %>% mutate(demo = "Age")
med_exp   <- exp_medians   %>% pivot_longer(-factor) %>% mutate(demo = "Experience")
med_gend  <- gender_medians%>% pivot_longer(-factor) %>% mutate(demo = "Gender")
med_mil   <- mil_medians   %>% pivot_longer(-factor) %>% mutate(demo = "Military")
med_carr  <- carrier_medians %>% pivot_longer(-factor) %>% mutate(demo = "Carrier")

heat_raw <- bind_rows(med_age, med_exp, med_gend, med_mil, med_carr) %>%
  filter(str_detect(name, "_median$")) %>%                # keep medians only
  separate(name, into = c("group", "metric"), sep = "_") %>%
  select(demo, group, factor, value) %>%
  mutate(group = str_replace_all(group, "\\.", " "))      # nicer labels

# 2. plot ----------------------------------------------------------------
ggplot(heat_raw, aes(x = factor, y = paste(demo, group, sep = ": "))) +
  geom_tile(aes(fill = value), colour = "white") +
  scale_fill_gradient(low = "steelblue", high = "lightgrey",
                      breaks = 1:6, limits = c(1, 6), name = "Median Rank") +
  labs(title = "Figure 2. Median Rank of Retention Factors by Demographic Group",
       x = "Retention Factor", y = "Demographic Sub‑Group") +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right")
```

```{r final-heatmap-blue-red}
library(dplyr); library(tidyr); library(ggplot2); library(stringr)

# 1. Gather median tables into one frame (reuse earlier objects) ----------
heat_raw <- bind_rows(
  age_medians      %>% pivot_longer(-factor) %>% mutate(demo = "Age"),
  exp_medians      %>% pivot_longer(-factor) %>% mutate(demo = "Experience"),
  gender_medians   %>% pivot_longer(-factor) %>% mutate(demo = "Gender"),
  mil_medians      %>% pivot_longer(-factor) %>% mutate(demo = "Military"),
  carrier_medians  %>% pivot_longer(-factor) %>% mutate(demo = "Carrier")
) %>%
  filter(str_detect(name, "_median$")) %>%                    # keep medians only
  separate(name, into = c("group", "metric"), sep = "_") %>%
  select(demo, group, factor, value) %>%
  mutate(
    group  = str_replace_all(group, "\\.", " "),
    factor = str_to_title(str_remove(factor, "_rank$"))       # Capitalise labels
  )

# 2. Heat‑map -------------------------------------------------------------
ggplot(heat_raw,
       aes(x = factor,
           y = paste(demo, group, sep = ": "),
           fill = value)) +
  geom_tile(colour = "white") +
  scale_fill_gradient2(
  low      = "firebrick",   # rank 1 (most important) → hot red
  mid      = "white",
  high     = "steelblue",   # rank 6 (least important) → cold blue
  midpoint = 3.5,
  breaks   = 1:6,
  limits   = c(1, 6),
  name     = "Median\nRank"
) +
  labs(title = "Figure 2. Median Rank of Retention Factors by Demographic Group",
       x = "Retention Factor",
       y = "Demographic Sub‑Group") +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right")
```

```{r RQ2c-position-corrected}
library(dplyr); library(tidyr); library(rstatix); library(stringr); library(knitr)

# 1 ── clean position variable -------------------------------------------
included_data <- included_data %>%
  mutate(
    position = case_when(
      str_detect(tolower(position_position), "captain")       ~ "Captain",
      str_detect(tolower(position_position), "first officer") ~ "First Officer",
      TRUE                                                    ~ NA_character_
    )
  )

cat("Position counts:\n")
print(table(included_data$position, useNA = "ifany"))   # should show 26 / 50

# 2 ── long rank data -----------------------------------------------------
position_long <- included_data %>%
  select(position, all_of(rank_cols)) %>%
  pivot_longer(cols = all_of(rank_cols),
               names_to = "factor",
               values_to = "rank") %>%
  mutate(
    factor = str_remove(factor, "_rank$"),
    rank   = as.numeric(rank)
  ) %>%
  filter(!is.na(position))

# 3 ── Table X1: medians by position -------------------------------------
pos_medians <- position_long %>%
  group_by(factor, position) %>%
  summarise(
    n      = n(),
    median = median(rank, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = position,
    values_from = c(n, median),
    names_glue  = "{position}_{.value}"
  )

knitr::kable(pos_medians,
             digits = 1,
             caption = "Table X1\nMedian Rank of General Factors by Flight‑Deck Position")

# 4 ── Mann‑Whitney tests -------------------------------------------------
pos_counts <- table(included_data$position)
if(all(pos_counts >= 5)){
  mw_pos <- position_long %>%
    group_by(factor) %>%
    wilcox_test(rank ~ position, exact = FALSE) %>%
    mutate(p_adj = p.adjust(p, method = "bonferroni")) %>%
    select(factor, p_adj)
  
  knitr::kable(mw_pos,
               digits = 3,
               caption = "Table X2\nMann‑Whitney U Tests: Captain vs First Officer (Bonferroni‑adjusted p)")
} else {
  cat("\nMann‑Whitney skipped: fewer than 5 cases in one position group.\n")
}
```

```{r heatmap-final, fig.height = 6, fig.width = 7}
library(dplyr); library(tidyr); library(ggplot2); library(stringr)

# ---------- 1. Assemble median tables -----------------------------------
heat_raw <- bind_rows(
  age_medians       %>% pivot_longer(-factor) %>% mutate(demo = "Age"),
  exp_medians       %>% pivot_longer(-factor) %>% mutate(demo = "Experience"),
  gender_medians    %>% pivot_longer(-factor) %>% mutate(demo = "Gender"),
  mil_medians       %>% pivot_longer(-factor) %>% mutate(demo = "Military"),
  pos_medians       %>% pivot_longer(-factor) %>% mutate(demo = "Position")   # new 2c
) %>%
  filter(str_detect(name, "_median$")) %>%              # keep medians
  separate(name, into = c("group", "metric"), sep = "_") %>%
  select(demo, group, factor, value) %>%
  mutate(
    group  = str_replace_all(group, "\\.", " "),
    factor = str_to_title(str_remove(factor, "_rank$"))  # Capitalise
  )

# ---------- 2. Heat map --------------------------------------------------
ggplot(heat_raw,
       aes(x = factor,
           y = paste(demo, group, sep = ": "),
           fill = value)) +
  geom_tile(colour = "white") +
  scale_fill_gradient2(
    low       = "firebrick",   # rank 1 (most important) → red (hot)
    mid       = "white",
    high      = "steelblue",   # rank 6 (least important) → blue (cold)
    midpoint  = 3.5,
    breaks    = 1:6,
    limits    = c(1, 6),
    name      = "Median\nRank"
  ) +
  labs(x = "Retention Factor", y = "Demographic Sub-Group") +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right")
```
